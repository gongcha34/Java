# 저장 서브프로그램 
## 1. 프로시저
```
SET SERVEROUTPUT ON;
CREATE OR REPLACE PROCEDURE SP_NOPARAM 
IS
    V_EMPNO NUMBER := 7688;
    V_NAME VARCHAR2(20);
BEGIN
    V_NAME := 'scott';
    DBMS_OUTPUT.PUT_LINE(V_NAME);
END;

CREATE OR REPLACE PROCEDURE SP_NOPARAM 
IS
    V_WRONG NUMBER;
BEGIN
    -- DNAME과 V_WRONG은 자료형이 다르다.
    SELECT DNAME INTO V_WRONG
    FROM DEPT WHERE DEPTNO = 10;
EXCEPTION
    WHEN VALUE_ERROR THEN
        DBMS_OUTPUT.PUT_LINE('예외 처리 : 수치 또는 값 오류 발생2');
        DBMS_OUTPUT.PUT_LINE(TO_CHAR(SQLCODE) || ' ' || SQLERRM);
    WHEN OTHERS THEN
     DBMS_OUTPUT.PUT_LINE('not-predefined error');
END;
/

-- 생성한 프로시저 실행하기
EXECUTE SP_NOPARAM;
-- 익명 블록에서 프로시저 실행하기
BEGIN
    SP_NOPARAM;
END;
/
-- 프로시저 삭제하기
DROP PROCEDURE SP_NOPARAM;

-- IN 모드 파라미터
CREATE OR REPLACE PROCEDURE SP_PARAM 
(
    PARAM1 IN NUMBER,
    PARAM2 NUMBER,
    PARAM3 NUMBER := 3,
    PARAM4 NUMBER DEFAULT 4
)
IS
BEGIN
    DBMS_OUTPUT.PUT_LINE(PARAM1 || PARAM2 || PARAM3 || PARAM4);
END;

-- IN 모드 파라미터 사용
EXECUTE SP_PARAM(1, 2, 9, 8); -- 1298

EXECUTE SP_PARAM(1, 2); -- 1234

EXECUTE SP_PARAM(1); -- 에러 발생: 'SP_PARAM' 호출 시 인수의 갯수나 유형이 잘못되었습니다.

EXECUTE SP_PARAM(PARAM1 =>1, PARAM2 => 20); -- 12034


-- OUT 모드 파라미터
CREATE OR REPLACE PROCEDURE SP_PARAMOUT
(
    IN_EMPNO IN EMP.EMPNO%TYPE,
    OUT_ENAME OUT EMP.ENAME%TYPE,
    OUT_SAL OUT EMP.SAL%TYPE
)
IS
BEGIN
    SELECT ENAME, SAL INTO OUT_ENAME, OUT_SAL
    FROM EMP WHERE EMPNO = IN_EMPNO;
END SP_PARAMOUT;

-- OUT 모드 파라미터 사용
DECLARE
    V_ENAME EMP.ENAME%TYPE;
    V_SAL EMP.SAL%TYPE;
BEGIN
    SP_PARAMOUT(7698, V_ENAME, V_SAL); 
    DBMS_OUTPUT.PUT_LINE('ENAME: ' || V_ENAME || ', SAL :' || V_SAL);
END;
/


-- IN OUT 모드 파라미터
CREATE OR REPLACE PROCEDURE SP_PARAMINOUT
(
    INOUT_NO IN OUT NUMBER
)
IS
BEGIN
   INOUT_NO := INOUT_NO * 2;
END SP_PARAMINOUT;


-- IN OUT 모드 파라미터 사용
DECLARE
    NO NUMBER; -- 변수 선언
BEGIN
    NO := 5;
    SP_PARAMINOUT(NO);
    DBMS_OUTPUT.PUT_LINE('NO: ' || NO);
END;
/

-- SYS_REFCURSOR
CREATE OR REPLACE PROCEDURE SP_EMP_DETAILS
(
    P_EMPNO IN NUMBER,
    P_EMP_DETAIL_CURSOR OUT SYS_REFCURSOR
)
IS
BEGIN
    OPEN P_EMP_DETAIL_CURSOR FOR
    SELECT * FROM EMP WHERE EMPNO = P_EMPNO;
END;
/

DECLARE
    L_EMP_DETAIL_CURSOR SYS_REFCURSOR;
    REC EMP%ROWTYPE;
BEGIN
    SP_EMP_DETAILS(7698, L_EMP_DETAIL_CURSOR);
    LOOP
        FETCH L_EMP_DETAIL_CURSOR INTO REC;
        EXIT WHEN L_EMP_DETAIL_CURSOR%NOTFOUND;
        DBMS_OUTPUT.PUT_LINE(REC.EMPNO || ' ' || REC.ENAME || ' ' ||  REC.JOB);
    END LOOP;
END;
/



```
## 2. 함수
```
-- 함수
CREATE OR REPLACE FUNCTION FN_AGTERTAX
(
    SAL IN NUMBER
)
RETURN NUMBER
IS
    TAX NUMBER := 0.05;
BEGIN
    RETURN (ROUND(SAL - (SAL * TAX)));
END;

-- FN_AGTERTAX 함수 호출
DECLARE
    AFTERTAX NUMBER;
BEGIN
    AFTERTAX := FN_AGTERTAX(3000);
    DBMS_OUTPUT.PUT_LINE(AFTERTAX);
END;
/

SELECT EMPNO, ENAME, SAL, FN_AGTERTAX(SAL) AS AFTERTAX FROM EMP;

-- 함수 2
CREATE OR REPLACE FUNCTION FN_EMP_DETAILS
(
    P_EMPNO IN NUMBER
)
RETURN SYS_REFCURSOR
IS
    L_EMP_DETAILS_CURSOR SYS_REFCURSOR;
BEGIN
    OPEN L_EMP_DETAILS_CURSOR FOR 
    SELECT * FROM EMP WHERE EMPNO = P_EMPNO;
    RETURN L_EMP_DETAILS_CURSOR;
END;

-- FN_EMP_DETAILS  함수 호출
DECLARE
    L_EMP_DETAILS_CURSOR SYS_REFCURSOR;
    REC EMP%ROWTYPE;
BEGIN
    L_EMP_DETAILS_CURSOR := FN_EMP_DETAILS(7698);
    LOOP
        FETCH L_EMP_DETAILS_CURSOR INTO REC;
        EXIT WHEN L_EMP_DETAILS_CURSOR%NOTFOUND;
        DBMS_OUTPUT.PUT_LINE(REC.ENAME);
    END LOOP;
END;
/

-- 함수 삭제
DROP FUNCTION FN_AFTERTAX;
```
## 패키지
```
SET SERVEROUTPUT ON;
DROP PACKAGE PKF_EXAMPLE;
DROP PACKAGE BODY PKF_EXAMPLE;
-- 패키지 명세
CREATE OR REPLACE PACKAGE PKF_EXAMPLE
IS
    SPEC_NO NUMBER := 10; -- 변수
    FUNCTION FN_AFTERTAX(SAL NUMBER) RETURN NUMBER; -- 함수
    PROCEDURE SP_EMP(IN_EMPNO IN EMP.EMPNO%TYPE); -- 프로시저
    PROCEDURE SP_DEPT(IN_DEPTNO IN DEPT.DEPTNO%TYPE); -- 프로시저
END;
/

-- 패키지 본문
CREATE OR REPLACE PACKAGE BODY PKF_EXAMPLE
IS
    BODY_NO NUMBER := 10;
    -- 함수
    FUNCTION FN_AFTERTAX(SAL NUMBER) RETURN NUMBER
    IS
        TAX NUMBER := 0.05;
    BEGIN
        RETURN (ROUND(SAL - (SAL *TAX)));
    END;
    -- 프로시저1
    PROCEDURE SP_EMP(IN_EMPNO IN EMP.EMPNO%TYPE)
    IS
        OUT_ENAME EMP.ENAME%TYPE;
        OUT_SAL EMP.SAL%TYPE;
    BEGIN
        SELECT ENAME, SAL INTO OUT_ENAME, OUT_SAL
        FROM EMP
        WHERE EMPNO = IN_EMPNO;
        
        DBMS_OUTPUT.PUT_LINE('ENAME: ' || OUT_ENAME);
        DBMS_OUTPUT.PUT_LINE('SAL: ' || OUT_SAL);
    END;
    -- 프로시저2
    PROCEDURE SP_DEPT(IN_DEPTNO IN DEPT.DEPTNO%TYPE)
    IS
        OUT_DNAME DEPT.DNAME%TYPE;
        OUT_LOC DEPT.LOC%TYPE;
    BEGIN
        SELECT DNAME, LOC INTO OUT_DNAME, OUT_LOC FROM DEPT WHERE DEPTNO = IN_DEPTNO;
        DBMS_OUTPUT.PUT_LINE('DNAME: ' || OUT_DNAME);
        DBMS_OUTPUT.PUT_LINE('LOC: ' || OUT_LOC);
    END;
END;
/

-- 호출
DECLARE
    AFTERTAX NUMBER;
BEGIN
 PKF_EXAMPLE.SP_EMP(7698);
 PKF_EXAMPLE.SP_DEPT(20);
 AFTERTAX := PKF_EXAMPLE.FN_AFTERTAX(2850);
 DBMS_OUTPUT.PUT_LINE('AFTERTAX: ' || AFTERTAX);
END;
/

-- 오버로드
-- 패키지 명세
CREATE OR REPLACE PACKAGE PKG_OVERLOAD
IS
    PROCEDURE SP_EMP(IN_EMPNO IN EMP.EMPNO%TYPE); 
    PROCEDURE SP_EMP(IN_ENAME IN EMP.ENAME%TYPE);
END;
/

-- 패키지 본문
CREATE OR REPLACE PACKAGE BODY PKG_OVERLOAD
IS
    -- 프로시저1
    PROCEDURE SP_EMP(IN_EMPNO IN EMP.EMPNO%TYPE)
    IS
        OUT_ENAME EMP.ENAME%TYPE;
        OUT_SAL EMP.SAL%TYPE;
    BEGIN
        SELECT ENAME, SAL INTO OUT_ENAME, OUT_SAL
        FROM EMP
        WHERE EMPNO = IN_EMPNO;
        
        DBMS_OUTPUT.PUT_LINE('ENAME: ' || OUT_ENAME);
        DBMS_OUTPUT.PUT_LINE('SAL: ' || OUT_SAL);
    END;
    -- 프로시저2
    PROCEDURE SP_EMP(IN_ENAME IN EMP.ENAME%TYPE)
    IS
        OUT_ENAME EMP.ENAME%TYPE;
        OUT_SAL EMP.SAL%TYPE;
    BEGIN
        SELECT ENAME, SAL INTO OUT_ENAME, OUT_SAL
        FROM EMP
        WHERE ENAME = IN_ENAME;
        
        DBMS_OUTPUT.PUT_LINE('ENAME: ' || OUT_ENAME);
        DBMS_OUTPUT.PUT_LINE('SAL: ' || OUT_SAL);
    END;
END;
/

-- 호출
BEGIN
 PKG_OVERLOAD.SP_EMP(7698);
 PKG_OVERLOAD.SP_EMP('BLAKE');
END;
/
```

## 트리거
```
CREATE TABLE EMP_TRG
    AS SELECT * FROM EMP;

CREATE OR REPLACE TRIGGER TRG_EMP_NODML_WEEKEND
BEFORE
    INSERT OR UPDATE OR DELETE ON EMP_TRG
BEGIN
    IF TO_CHAR(SYSDATE, 'DY') IN ('토', '일') THEN
        IF INSERTING THEN
            raise_application_error(-20000, 'no ins');
        ELSIF UPDATING THEN
            raise_application_error(-20001, 'no upd');
        ELSIF DELETING THEN
            raise_application_error(-20002, 'no del');
        ELSE
            raise_application_error(-20003, 'no chg');
        END IF;
    END IF;
END;
/

CREATE OR REPLACE TRIGGER TRG_WEEKEND
BEFORE
INSERT OR UPDATE OR DELETE ON EMP_TRG
BEGIN
    IF TO_CHAR(SYSDATE, 'DY') IN ('토', '일') THEN
        IF INSERTING THEN
            raise_application_error(-20000, 'no ins');
        ELSIF UPDATING THEN
            raise_application_error(-20001, 'no upd');
        ELSIF DELETING THEN
            raise_application_error(-20002, 'no del');
        ELSE
            raise_application_error(-20003, 'no chg');
        END IF;
    END IF;
END;
/
DELETE FROM EMP_TRG;
SELECT * FROM EMP_TRG;

UPDATE EMP_TRG SET SAL = 3200 WHERE EMPNO = 7698;

-- 트리거 AFTER
CREATE TABLE EM_LOG(
    TABLENAME VARCHAR2(10),
    DMLTYPE VARCHAR2(10),
    EMPNO NUMBER(4),
    USERNAME VARCHAR2(30),
    CHANGEDATE DATE
);

CREATE OR REPLACE TRIGGER TRG_EMP_LOG
AFTER
INSERT OR UPDATE OR DELETE ON EMP_TRG
FOR EACH ROW -- 각가의 ROW에 대해서
BEGIN
    IF INSERTING THEN
        INSERT INTO EM_LOG VALUES('EMP_TRG', 'INSERT', :NEW.EMPNO, SYS_CONTEXT('YSERENV', 'SESSIN_USER'), SYSDATE);
    ELSIF UPDATING THEN
        INSERT INTO EM_LOG VALUES('EMP_TRG', 'UPDATE', :OLD.EMPNO, SYS_CONTEXT('YSERENV', 'SESSIN_USER'), SYSDATE);
     ELSIF DELETING THEN
        INSERT INTO EM_LOG VALUES('EMP_TRG', 'DELETE', :OLD.EMPNO, SYS_CONTEXT('YSERENV', 'SESSIN_USER'), SYSDATE);
    END IF;
END;
/
-- 생성, 업데이트, 삭제
INSERT INTO EMP_TRG VALUES (9999, 'KIM1', 'CLERK', 7839, SYSDATE, 1200, NULL, 20);
UPDATE EMP_TRG SET SAL = 800 WHERE EMPNO = 9999;
DELETE FROM EM_LOG;

-- 조회
SELECT * FROM EM_LOG;

DELETE FROM EMP_TRG WHERE EMPNO = 9999;
SELECT * FROM EMP_TRG;
```




# *Reference
+ [오라클로 배우는 데이터베이스 입문](http://www.yes24.com/Product/Goods/65849798)
